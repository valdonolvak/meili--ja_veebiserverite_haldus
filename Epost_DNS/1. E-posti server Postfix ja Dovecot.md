Testkeskkonna jaoks on **self-signed** (isetunnustatud) sertifikaadi kasutamine täiesti mõistlik, et vältida Certbot'iga seotud väljakutseid, kui masin pole avalikult kättesaadav. Järgnev juhend keskendub isetunnustatud sertifikaadi loomisele ja Postfix/Dovecot'i seadistamisele, jättes Let's Encrypti osa välja.

**Meiliserveri domeen on: `minumeil.ee`**
**Serveri hostinimi (FQDN): `mail.minumeil.ee`**

-----

## 1\. Eeltöö ja Serveri Ettevalmistus 🛠️

### 1.1. Hostinime Seadistamine

Seadistage oma serveri hostinimi.

```bash
# Asenda mail.minumeil.ee ja minumeil.ee oma tegelike väärtustega
sudo hostnamectl set-hostname mail.minumeil.ee
echo "127.0.0.1 mail.minumeil.ee mail localhost" | sudo tee -a /etc/hosts
```

### 1.2. DNS Kirjed (Testkeskkonnas)

Kui tegemist on testkeskkonnaga, peate tagama, et server ise ja teised masinad võrgus teaksid, mis on `minumeil.ee` IP-aadress. Lisage need kirjed **oma võrgu DNS-serverisse** või **testmasinate `/etc/hosts`** failidesse. Asendage `$SERVER_IP` oma VM-i sisevõrgu IP-ga.

| Tüüp | Host/Nimi | Väärtus | Eesmärk |
| :--- | :--- | :--- | :--- |
| **A** | `mail.minumeil.ee` | `$SERVER_IP` | Meiliserveri IP |
| **MX** | `minumeil.ee` | `mail.minumeil.ee` (Prioriteet 10) | Peamine meilivahetaja |

-----

## 2\. TLS/SSL Sertifikaadi Loomine (Self-Signed) 🔒

Loome isetunnustatud sertifikaadi, mis kehtib serveri hostinimele (`mail.minumeil.ee`).

```bash
# Loo kataloog privaatvõtmete jaoks
sudo mkdir -p /etc/ssl/mail
sudo chmod 700 /etc/ssl/mail

# Loo isetunnustatud 2048-bitine sertifikaat
# Tähelepanu! CN (Common Name) peab ühtima serveri FQDN-ga (mail.minumeil.ee)
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/mail/mail.minumeil.ee.key -out /etc/ssl/mail/mail.minumeil.ee.crt

# Käsu käivitamisel sisesta andmed:
# Country Name (2 letter code) [AU]: EE
# State or Province Name (full name) [Some-State]: Harjumaa
# Locality Name (eg, city) []: Tallinn
# Organization Name (eg, company) [Internet Widgits Pty Ltd]: Test Labs
# Organizational Unit Name (eg, section) []: IT
# Common Name (e.g. server FQDN or YOUR name) []: mail.minumeil.ee  <--- SEE ON OLULINE!
# Email Address []: postmaster@minumeil.ee
```

Sertifikaadi failid:

  * **Privaatvõti:** `/etc/ssl/mail/mail.minumeil.ee.key`
  * **Sertifikaat:** `/etc/ssl/mail/mail.minumeil.ee.crt`

-----

## 3\. Postfix'i Seadistamine (Saatmine/SMTP) 📧

### 3.1. Postfix'i Paigaldamine

Valige paigaldamisel **"Internet Site"** ja sisestage **System mail name**: `minumeil.ee`.

```bash
sudo apt update
sudo apt install postfix mailutils
```

### 3.2. Postfix'i Põhikonfiguratsioon

Muutke faili `/etc/postfix/main.cf`:

```bash
sudo nano /etc/postfix/main.cf
```

Lisage/muutke järgmised read:

```postfix
# POSTFIX PÕHIKONFIGURATSIOON
myhostname = mail.minumeil.ee
mydomain = minumeil.ee
myorigin = $mydomain
inet_interfaces = all
mydestination = $myhostname, $mydomain, localhost.$mydomain, localhost
home_mailbox = Maildir/                # Kasutame Maildir formaati

# TLS/SSL SEADISTUS (Self-Signed sertifikaadiga)
smtpd_tls_cert_file = /etc/ssl/mail/mail.minumeil.ee.crt # Isetunnustatud sertifikaat
smtpd_tls_key_file = /etc/ssl/mail/mail.minumeil.ee.key   # Privaatvõti
smtpd_use_tls = yes
smtpd_tls_security_level = may
smtp_tls_security_level = may
smtpd_tls_protocols = !SSLv2, !SSLv3

# SMTP AUTH (Autentimine) seadistus Dovecot'i kaudu
smtpd_sasl_auth_enable = yes
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_security_options = noanonymous
smtpd_recipient_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination

# E-kirjade kohaletoimetamine Dovecot'i kaudu
mailbox_transport = lmtp:unix:private/dovecot-lmtp
```

### 3.3. Postfix'i Uuesti Laadimine

```bash
sudo systemctl restart postfix
```

-----

## 4\. Dovecot'i Seadistamine (Vastuvõtmine/IMAP/POP3) 📥

### 4.1. Dovecot'i Paigaldamine

```bash
sudo apt install dovecot-imapd dovecot-pop3d dovecot-lmtpd
```

### 4.2. E-kirjade Asukoht (Maildir)

Muutke faili `/etc/dovecot/conf.d/10-mail.conf`:

```bash
sudo nano /etc/dovecot/conf.d/10-mail.conf
```

```dovecot
mail_location = maildir:~/Maildir # Maildir asukoht kasutaja kodukataloogis
```

### 4.3. Autentimine (SASL)

Muutke faili `/etc/dovecot/conf.d/10-auth.conf`:

```bash
sudo nano /etc/dovecot/conf.d/10-auth.conf
```

Veenduge, et:

```dovecot
disable_plaintext_auth = yes
auth_mechanisms = plain login
!include auth-system.conf.ext
```

### 4.4. TLS/SSL Seadistamine Dovecot'is

Muutke faili `/etc/dovecot/conf.d/10-ssl.conf`:

```bash
sudo nano /etc/dovecot/conf.d/10-ssl.conf
```

Seadistage TLS kohustuslikuks ja suunake isetunnustatud sertifikaadile:

```dovecot
ssl = required
ssl_cert = </etc/ssl/mail/mail.minumeil.ee.crt  # Isetunnustatud sertifikaat
ssl_key = </etc/ssl/mail/mail.minumeil.ee.key    # Privaatvõti
ssl_min_protocol = TLSv1.2
```

### 4.5. Dovecot'i Sokkel Postfix'i jaoks

Muutke faili `/etc/dovecot/conf.d/10-master.conf`. Leidke sektsioon `service auth {}` ja lisage/kontrollige Postfix'i sokli seadistust:

```dovecot
service auth {
  # Postfix'i jaoks
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
}
```

### 4.6. Dovecot'i Taaskäivitamine

```bash
sudo systemctl restart dovecot
```

-----

## 5\. E-posti Autentimine (DKIM) 🔑

Kasutame **OpenDKIM** paketti väljaminevate kirjade digitaalse allkirjastamiseks.

### 5.1. OpenDKIM'i Paigaldamine

```bash
sudo apt install opendkim opendkim-tools
```

### 5.2. Võtmepaari Loomine

Valige selektor (nt `default`).

```bash
# Asendage 'default' oma valitud selektoriga
sudo mkdir -p /etc/opendkim/keys/minumeil.ee
sudo opendkim-genkey -b 2048 -d minumeil.ee -D /etc/opendkim/keys/minumeil.ee -s default
sudo chown -R opendkim:opendkim /etc/opendkim/keys/minumeil.ee
```

### 5.3. OpenDKIM'i Konfiguratsioon

Muutke faili `/etc/opendkim.conf`:

```bash
sudo nano /etc/opendkim.conf
```

Veenduge, et järgmised parameetrid on seadistatud:

```opendkim
Domain                  minumeil.ee
Selector                default
Socket                  inet:8891@localhost # Postfix'i milteri pordi
Mode                    sv
Canonicalization        relaxed/simple
UserID                  opendkim
PidFile                 /run/opendkim/opendkim.pid

# Kaardistustabelid:
KeyTable                refile:/etc/opendkim/KeyTable
SigningTable            refile:/etc/opendkim/SigningTable
ExternalIgnoreList      refile:/etc/opendkim/TrustedHosts
InternalHosts           refile:/etc/opendkim/TrustedHosts
```

Looge kaardistustabelid:

```bash
# KeyTable
sudo nano /etc/opendkim/KeyTable
default._domainkey.minumeil.ee minumeil.ee:default:/etc/opendkim/keys/minumeil.ee/default.private

# SigningTable
sudo nano /etc/opendkim/SigningTable
*@minumeil.ee default._domainkey.minumeil.ee

# TrustedHosts
sudo nano /etc/opendkim/TrustedHosts
127.0.0.1
localhost
mail.minumeil.ee
.minumeil.ee
```

### 5.4. Postfix'i Ühendamine OpenDKIM'iga

Lisage Postfix'i põhikonfiguratsiooni (`/etc/postfix/main.cf`) lõppu:

```postfix
# POSTFIX DKIM SEADISTUSED
smtpd_milters = inet:127.0.0.1:8891
non_smtpd_milters = $smtpd_milters
milter_default_action = accept
```

### 5.5. OpenDKIM'i ja Postfix'i Taaskäivitamine

```bash
sudo systemctl restart opendkim
sudo systemctl restart postfix
```

### 5.6. DKIM DNS Kirje (Peate selle lisama oma **testi DNS-serverisse** või `/etc/hosts`-i)

Kuvage avalik võti, mille peate lisama oma testkeskkonna DNS-i:

```bash
cat /etc/opendkim/keys/minumeil.ee/default.txt
```

| Tüüp | Host/Nimi | Väärtus | Eesmärk |
| :--- | :--- | :--- | :--- |
| **TXT (DKIM)**| `default._domainkey` | *Kopeeritud pikk TXT väärtus* | Kontrollib väljamineva kirja allkirja kehtivust. |

-----

## 6\. SPF ja DMARC Konfiguratsioon (Testkeskkonnas) 📝

Kuigi DKIM ja SPF on testkeskkonnas teistele (avaline internet) kättesaamatud, on hea harjutada ka nende kirjeid. Lisage need oma **testkeskkonna DNS-serverisse**.

| Tüüp | Host/Nimi | Väärtus | Eesmärk |
| :--- | :--- | :--- | :--- |
| **TXT (SPF)**| `@` | `"v=spf1 a mx ip4:$SERVER_IP ~all"` | Lubab saatmist ainult serveri A/MX kirjetega seotud IP-lt. |
| **TXT (DMARC)**| `_dmarc` | `"v=DMARC1; p=none; rua=mailto:postmaster@minumeil.ee"` | Seadistab DMARC-i poliitika vaikimisi **jälgimisrežiimi** (`p=none`). |

-----

## 7\. Testkasutaja Loomine ja Tulemüür 🧑‍💻

### 7.1. E-posti Kasutaja Loomine

Loo süsteemikasutaja, mida kasutatakse meilikontona:

```bash
sudo adduser kasutaja1
# Sisesta parool ja muu info

# Loo Maildir
sudo mkdir -p /home/kasutaja1/Maildir
sudo chown -R kasutaja1:kasutaja1 /home/kasutaja1/Maildir
sudo chmod -R 700 /home/kasutaja1/Maildir
```

### 7.2. Tulemüüri Seadistamine (UFW)

```bash
sudo apt install ufw
# Sissetuleva meili pordid
sudo ufw allow 25/tcp  comment 'SMTP'
sudo ufw allow 993/tcp comment 'IMAPS'
sudo ufw allow 995/tcp comment 'POP3S'
sudo ufw allow 587/tcp comment 'Submission'

sudo ufw enable
```

### 7.3. Testimine

Kasutage meiliprogrammi (nt Thunderbird) ja looge uus konto:

| Seade | Väärtus |
| :--- | :--- |
| **Domeen** | `mail.minumeil.ee` |
| **Kasutajanimi** | `kasutaja1` |
| **Parool** | *kasutaja1 parool* |
| **SMTP (Saatmine)** | Port **587**, Turvalisus: **STARTTLS** |
| **IMAP/POP3 (Vastuvõtmine)** | Port **993** (IMAPS) või **995** (POP3S), Turvalisus: **SSL/TLS** |

**Märkus isetunnustatud sertifikaadi kohta:** E-posti klient (nt Thunderbird) annab teile hoiatuse, et serveri sertifikaati ei saa kinnitada, kuna see on isetunnustatud. **Peate selle hoiatuse ignoreerima või sertifikaadi oma kliendis käsitsi "usaldama"**, et ühendus toimiks.
