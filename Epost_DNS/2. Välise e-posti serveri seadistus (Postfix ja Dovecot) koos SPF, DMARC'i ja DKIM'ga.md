Juhend **Postfix** (SMTP/saatmine), **Dovecot** (IMAP/POP3/vastuv√µtmine) ja e-posti autentimisstandardite (**SPF, DKIM, DMARC**) seadistamiseks Debianil, kasutades **TLS/SSL**-i turvaliseks √ºhenduseks. Asendage k√µikjal `minumeil.ee` oma tegeliku domeeninimega ja `mail.minumeil.ee` oma serveri alamdomeeniga.

## 1\. Eelt√∂√∂ ja DNS-i seadistus üåê

### 1.1. Serveri Hostinimi

Seadistage oma serveri hostinimi (FQDN) kujul `mail.minumeil.ee`.

```bash
# Asenda mail.minumeil.ee ja minumeil.ee oma tegelike v√§√§rtustega
sudo hostnamectl set-hostname mail.minumeil.ee
echo "127.0.0.1 mail.minumeil.ee mail localhost" | sudo tee -a /etc/hosts
```

### 1.2. DNS Kirjed (Domeeni Haldur)

Need kirjed tuleb lisada domeeni `minumeil.ee` DNS seadistustesse (tavaliselt teie domeeniregistripidaja kaudu). Asendage `$SERVER_IP` oma serveri avaliku IP-aadressiga.

| T√º√ºp | Host/Nimi | V√§√§rtus | Eesm√§rk |
| :--- | :--- | :--- | :--- |
| **A** | `mail` | `$SERVER_IP` | M√§√§rab e-posti serveri IP-aadressi. |
| **MX** | `@` | `mail.minumeil.ee` (Prioriteet 10) | M√§√§rab serveri `mail.minumeil.ee` domeeni peamiseks e-posti vahetajaks. |
| **TXT (SPF)**| `@` | `"v=spf1 a mx ip4:$SERVER_IP ~all"` | **SPF (Sender Policy Framework)**: Lubab saata e-kirju ainult sellelt IP-aadressilt, mis on seotud A/MX kirjega ja m√§√§ratud IP-ga. `~all` t√§hendab "pehme viga" (softfail). |
| **TXT (DMARC)**| `_dmarc` | `"v=DMARC1; p=none; rua=mailto:postmaster@minumeil.ee"` | **DMARC (Domain-based Message Authentication, Reporting, and Conformance)**: M√§√§rab eeskirjad (antud juhul `p=none` ‚Äì ainult j√§lgimine) e-kirjadele, mis ei l√§bi SPF/DKIM kontrolle. Aruanded saadetakse `postmaster@minumeil.ee` aadressile. |

-----

## 2\. TLS/SSL Sertifikaadi Seadistamine (Certbot/Let's Encrypt) üîí

Kasutame **Certbot'i** **Let's Encrypt'i** sertifikaadi saamiseks. See pakub tasuta ja usaldusv√§√§rseid sertifikaate.

```bash
# Paigalda Certbot
sudo apt update
sudo apt install certbot

# Hangi sertifikaat - asenda mail.minumeil.ee
# Kasutame --standalone meetodit. Kui serveris t√∂√∂tab port 80-l veebiserver, tuleb see enne k√§su k√§ivitamist peatada!
sudo certbot certonly --standalone -d mail.minumeil.ee --agree-tos --email sinu@email.ee --rsa-key-size 4096
```

Sertifikaadi failid asuvad n√º√ºd:

  * **Privaatv√µti:** `/etc/letsencrypt/live/mail.minumeil.ee/privkey.pem`
  * **Sertifikaadi kett:** `/etc/letsencrypt/live/mail.minumeil.ee/fullchain.pem`

-----

## 3\. Postfix'i Seadistamine (Saatmine/SMTP) üìß

### 3.1. Postfix'i Paigaldamine

Valige paigaldamisel **"Internet Site"** ja sisestage **System mail name** (S√ºsteemi meilinimi): `minumeil.ee`.

```bash
sudo apt install postfix mailutils
```

### 3.2. Postfix'i P√µhikonfiguratsioon

Muutke faili `/etc/postfix/main.cf`:

```bash
sudo nano /etc/postfix/main.cf
```

Lisage/muutke j√§rgmised read:

```postfix
# POSTFIX P√ïHIKONFIGURATSIOON
myhostname = mail.minumeil.ee           # Serveri hostinimi (tuleb √ºhilduda sertifikaadi nimega)
mydomain = minumeil.ee                 # Domeeni nimi
myorigin = $mydomain                   # V√§ljaminevate e-kirjade domeen
inet_interfaces = all                  # Kuulamine k√µigil v√µrguliidestel
mydestination = $myhostname, $mydomain, localhost.$mydomain, localhost # Domeenid, mille jaoks server v√µtab vastu e-kirju
mailbox_size_limit = 0                 # Postkasti suurus: 0 = piiramatu
recipient_delimiter = +                # Lubab kasutada aadresse kujul kasutaja+silt@minumeil.ee
home_mailbox = Maildir/                # E-kirjade salvestusformaat (Maildir on kaasaegsem)

# TLS/SSL SEADISTUS (kasutab Let's Encrypt sertifikaati)
smtpd_tls_cert_file = /etc/letsencrypt/live/mail.minumeil.ee/fullchain.pem # Sertifikaadi kett
smtpd_tls_key_file = /etc/letsencrypt/live/mail.minumeil.ee/privkey.pem    # Privaatv√µti
smtpd_use_tls = yes
smtpd_tls_security_level = may         # Eelistab TLS-i, kuid lubab ka ilma TLS-ita (v√µib muuta "encrypt" v√µi "dane" rangemaks seadistuseks)
smtp_tls_security_level = may          # V√§ljamineva meili TLS seadistus
smtpd_tls_protocols = !SSLv2, !SSLv3   # Keelab vananenud SSL protokollid

# SMTP AUTH (Autentimine) seadistus Dovecot'i kaudu
smtpd_sasl_auth_enable = yes           # Luba SMTP autentimine
smtpd_sasl_type = dovecot              # Kasuta autentimiseks Dovecot'i
smtpd_sasl_path = private/auth         # Soketi asukoht
smtpd_sasl_security_options = noanonymous # Keela anon√º√ºmne sisselogimine
smtpd_recipient_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,         # Luba saatmine autentitud kasutajatele
    reject_unauth_destination          # Keela √ºlej√§√§nud

# OpenDKIM seadistused (lisatakse hiljem)
# smtpd_milters = inet:127.0.0.1:8891
# non_smtpd_milters = $smtpd_milters
# milter_default_action = accept
```

### 3.3. Postfix'i Uuesti Laadimine

```bash
sudo systemctl restart postfix
```

-----

## 4\. Dovecot'i Seadistamine (Vastuv√µtmine/IMAP/POP3) üì•

### 4.1. Dovecot'i Paigaldamine

Paigaldame Dovecot'i IMAP ja POP3 toega:

```bash
sudo apt install dovecot-imapd dovecot-pop3d dovecot-lmtpd
```

### 4.2. E-kirjade Asukoht (Maildir)

Muutke faili `/etc/dovecot/conf.d/10-mail.conf`:

```bash
sudo nano /etc/dovecot/conf.d/10-mail.conf
```

Leidke rida `mail_location` ja muutke see j√§rgmiseks:

```dovecot
mail_location = maildir:~/Maildir # Kasuta Maildir formaati e-kirjade salvestamiseks kasutaja kodukataloogi.
```

### 4.3. Autentimine (SASL)

Muutke faili `/etc/dovecot/conf.d/10-auth.conf`:

```bash
sudo nano /etc/dovecot/conf.d/10-auth.conf
```

Veenduge, et autentimismehhanismid on seadistatud ja s√ºsteemikasutajad on lubatud:

```dovecot
disable_plaintext_auth = yes         # Keela paroolide saatmine kr√ºpteerimata kujul
auth_mechanisms = plain login        # Lubatud autentimismehhanismid

# Kasuta s√ºsteemi kasutajate andmebaasi (selle Postfixi seadistuse jaoks)
!include auth-system.conf.ext
```

### 4.4. TLS/SSL Seadistamine Dovecot'is

Muutke faili `/etc/dovecot/conf.d/10-ssl.conf`:

```bash
sudo nano /etc/dovecot/conf.d/10-ssl.conf
```

Seadistage TLS kohustuslikuks ja suunake Certbot'i sertifikaadile:

```dovecot
ssl = required                           # Tee TLS kohustuslikuks
ssl_cert = </etc/letsencrypt/live/mail.minumeil.ee/fullchain.pem # Sertifikaadi kett
ssl_key = </etc/letsencrypt/live/mail.minumeil.ee/privkey.pem    # Privaatv√µti
ssl_min_protocol = TLSv1.2               # Kasuta minimaalselt TLS 1.2 turvalisuse tagamiseks
```

### 4.5. Dovecot'i Sokkel (Socket) Postfix'i jaoks

Muutke faili `/etc/dovecot/conf.d/10-master.conf` ‚Äì see lubab Postfix'il kasutada Dovecot'i autentimissoklit:

```bash
sudo nano /etc/dovecot/conf.d/10-master.conf
```

Leidke sektsioon `service auth {}` ja veenduge, et seal on **Postfix'i jaoks m√µeldud sokli seadistus** olemas:

```dovecot
service auth {
  # Postfix'i jaoks
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  }
}
```

### 4.6. E-kirjade Kohaletoimetamine (LMTP)

Seadistage Dovecot'i **LMTP (Local Mail Transfer Protocol)**, et Postfix saaks e-kirjad Dovecot'ile √ºle anda.

Lisage **Postfix'i** p√µhikonfiguratsiooni (`/etc/postfix/main.cf`) j√§rgmine rida (kui seda juba pole):

```postfix
mailbox_transport = lmtp:unix:private/dovecot-lmtp # Suunab kohaliku e-kirja √ºleandmise Dovecot'i LMTP sokli kaudu
```

### 4.7. Dovecot'i Taask√§ivitamine

```bash
sudo systemctl restart dovecot
```

-----

## 5\. E-posti Autentimine (DKIM/OpenDKIM) üîë

Kasutame **OpenDKIM** paketti v√§ljaminevate kirjade digitaalse allkirjastamiseks.

### 5.1. OpenDKIM'i Paigaldamine

```bash
sudo apt install opendkim opendkim-tools
```

### 5.2. V√µtmepaari Loomine

Valige v√µtme **selektor** (n√§iteks `default`).

```bash
# Asendage 'default' oma valitud selektoriga ja minumeil.ee domeeniga
sudo mkdir -p /etc/opendkim/keys/minumeil.ee
sudo opendkim-genkey -b 2048 -d minumeil.ee -D /etc/opendkim/keys/minumeil.ee -s default
sudo chown -R opendkim:opendkim /etc/opendkim/keys/minumeil.ee
```

### 5.3. OpenDKIM'i Konfiguratsioon

Muutke faili `/etc/opendkim.conf`:

```bash
sudo nano /etc/opendkim.conf
```

Veenduge, et j√§rgmised parameetrid on seadistatud:

```opendkim
Domain                  minumeil.ee # Allkirjastatav domeen
KeyFile                 /etc/opendkim/keys/minumeil.ee/default.private # Privaatv√µtme asukoht
Selector                default     # Kasutatav selektor
Socket                  inet:8891@localhost # Kuula localhost pordil 8891 (Postfix suhtleb selle kaudu)

# Muud olulised seadistused
Mode                    sv          # Allkirjastamine (s) ja kontroll (v)
Canonicalization        relaxed/simple
UserID                  opendkim
UMask                   007
PidFile                 /run/opendkim/opendkim.pid

# Osuta kaardistusfailidele:
KeyTable                refile:/etc/opendkim/KeyTable
SigningTable            refile:/etc/opendkim/SigningTable
ExternalIgnoreList      refile:/etc/opendkim/TrustedHosts
InternalHosts           refile:/etc/opendkim/TrustedHosts
```

Looge kaardistustabelid:

```bash
sudo nano /etc/opendkim/KeyTable
```

```keytable
# DKIM v√µtmete kaardistamine
default._domainkey.minumeil.ee minumeil.ee:default:/etc/opendkim/keys/minumeil.ee/default.private
```

```bash
sudo nano /etc/opendkim/SigningTable
```

```signingtable
# M√§√§rab, milliseid e-kirju allkirjastada
*@minumeil.ee default._domainkey.minumeil.ee
```

```bash
sudo nano /etc/opendkim/TrustedHosts
```

```trustedhosts
# Usaldusv√§√§rsed hostid, millelt e-kirju allkirjastada
127.0.0.1
localhost
mail.minumeil.ee
.minumeil.ee
```

### 5.4. Postfix'i √úhendamine OpenDKIM'iga

Lisage Postfix'i p√µhikonfiguratsiooni (`/etc/postfix/main.cf`) j√§rgmised read, et Postfix kasutaks OpenDKIM'i milterit:

```postfix
# POSTFIX DKIM SEADISTUSED (lisa faili l√µppu)
smtpd_milters = inet:127.0.0.1:8891
non_smtpd_milters = $smtpd_milters
milter_default_action = accept
```

### 5.5. OpenDKIM'i ja Postfix'i Taask√§ivitamine

```bash
sudo systemctl restart opendkim
sudo systemctl restart postfix
```

### 5.6. DKIM DNS Kirje Lisamine

Teie avalik v√µti asub failis `/etc/opendkim/keys/minumeil.ee/default.txt`. Kuvage see:

```bash
cat /etc/opendkim/keys/minumeil.ee/default.txt
```

Kopeerige sealt saadud pikk **TXT v√§√§rtus** ja lisage see oma domeeni DNS-i:

| T√º√ºp | Host/Nimi | V√§√§rtus | Eesm√§rk |
| :--- | :--- | :--- | :--- |
| **TXT (DKIM)**| `default._domainkey` | *Kopeeritud pikk TXT v√§√§rtus* | **DKIM (DomainKeys Identified Mail)**: Sisaldab avalikku v√µtit, millega saaja server saab kontrollida v√§ljamineva kirja allkirja kehtivust. |

-----

## 6\. Kasutaja Loomine ja Testimine üßë‚Äçüíª

### 6.1. E-posti Kasutaja Loomine

Meie praegune seadistus kasutab s√ºsteemikasutajaid.

```bash
sudo adduser kasutaja1
# J√§rgige juhiseid parooli sisestamiseks
```

Loo ka Maildir kataloog ja veendu, et √µigused on korras:

```bash
sudo mkdir /home/kasutaja1/Maildir
sudo chown -R kasutaja1:kasutaja1 /home/kasutaja1/Maildir
sudo chmod -R 700 /home/kasutaja1/Maildir
```

### 6.2. Testimine

1.  **V√§ljaminev e-kiri (SMTP):** Kasutage `mail` k√§sku v√µi meiliprogrammi, et saata testkiri (nt Gmaili) ja kontrollida, kas SPF, DKIM ja DMARC kontrollid on edukad.

    ```bash
    echo "See on testkiri." | mail -s "Testkiri Postfix'ist" siht@aadress.ee
    ```

2.  **Sissetulev e-kiri (IMAP/POP3):** Proovige sisse logida oma meiliprogrammiga (Thunderbird, Outlook vms) serverisse **mail.minumeil.ee** kasutades **kasutaja1** andmeid.

| Protokoll | Port | Turvalisus |
| :--- | :--- | :--- |
| **SMTP (Saatmine)** | 587 (Submission) | TLS/STARTTLS (Kohustuslik) |
| **IMAP (Vastuv√µtmine)** | 993 (IMAPS) | TLS/SSL (Kohustuslik) |
| **POP3 (Vastuv√µtmine)** | 995 (POP3S) | TLS/SSL (Kohustuslik) |

-----

## 7\. Tulem√º√ºri Seadistamine (UFW) üî•

Avage vajalikud pordid:

```bash
# Sissetuleva meili pordid
sudo ufw allow 25/tcp  comment 'SMTP'

# Kr√ºpteeritud meili vastuv√µtmise pordid (IMAPS/POP3S)
sudo ufw allow 993/tcp comment 'IMAPS'
sudo ufw allow 995/tcp comment 'POP3S'

# Kr√ºpteeritud meili saatmise port (SMTP Submission - autentitud saatmine)
sudo ufw allow 587/tcp comment 'Submission'

# Rakenda tulem√º√ºri reeglid
sudo ufw enable
```
